name: Build and Package

on:
  push:
    branches: [ master, main ]
    paths:
      - '**.vbp'
      - '**.frm'
      - '**.bas'
      - '**.cls'
      - '**.ctl'
      - 'installer/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    name: Build VB6 and Installer
    runs-on: self-hosted

    env:
      VB6: 'C:\Program Files (x86)\Microsoft Visual Studio\VB98\VB6.EXE'
      ISCC: 'C:\Program Files (x86)\Inno Setup 6\ISCC.exe'
      BUILD_DIR: 'C:\lpfacturacion-build'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare build directory
        shell: cmd
        run: |
          if exist "%BUILD_DIR%\LpFacturacion" (
            echo Removing existing build directory...
            rd /s /q "%BUILD_DIR%\LpFacturacion" 2>nul
            timeout /t 2 /nobreak >nul
          )
          echo Copying files to build directory...
          robocopy "%GITHUB_WORKSPACE%" "%BUILD_DIR%\LpFacturacion" /E /NFL /NDL /NJH /NJS /NC /NS /XD .git
          if %ERRORLEVEL% GEQ 8 exit /b 1
          exit /b 0

      - name: Build VB6 projects
        shell: cmd
        run: |
          echo === Compilando proyectos VB6 ===

          echo [1/2] NetCodePrueba1.exe
          "%VB6%" /make "%BUILD_DIR%\LpFacturacion\Facturacion\NetCode\Project1.vbp" /outdir "%BUILD_DIR%\LpFacturacion\installer\Archivos"
          if errorlevel 1 exit /b 1

          echo [2/2] TRFacturacion.exe
          "%VB6%" /make "%BUILD_DIR%\LpFacturacion\Facturacion\LPFacturacion\LPFacturacion.vbp" /outdir "%BUILD_DIR%\LpFacturacion\installer\Archivos"
          if errorlevel 1 exit /b 1

          echo.
          echo === VB6 BUILD EXITOSO ===
          dir "%BUILD_DIR%\LpFacturacion\installer\Archivos\*.exe"

      - name: Build Installer
        shell: cmd
        run: |
          echo === Compilando instalador con Inno Setup ===
          "%ISCC%" "%BUILD_DIR%\LpFacturacion\installer\installer.iss"
          if errorlevel 1 exit /b 1

          echo.
          echo === INSTALLER BUILD EXITOSO ===
          dir "%BUILD_DIR%\LpFacturacion\installer\*.exe"

      - name: Upload VB6 executables
        uses: actions/upload-artifact@v4
        with:
          name: vb6-executables-${{ github.sha }}
          path: |
            C:\lpfacturacion-build\LpFacturacion\installer\Archivos\NetCodePrueba1.exe
            C:\lpfacturacion-build\LpFacturacion\installer\Archivos\TRFacturacion.exe
          retention-days: 30

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: installer-${{ github.sha }}
          path: C:\lpfacturacion-build\LpFacturacion\installer\TRFactura*.exe
          retention-days: 30
